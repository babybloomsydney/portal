<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Bloom | Developer Console</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0fdf4; } /* Soft Green background */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .loading-spinner { border-top-color: #34d399; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-700 font-sans min-h-screen p-4 sm:p-8">

    <!-- HEADER & CONFIG -->
    <div class="max-w-5xl mx-auto mb-8 space-y-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-emerald-800"><i class="fa-solid fa-seedling mr-2"></i>Baby Bloom</h1>
                <p class="text-sm text-emerald-600">Dev Test Harness v1.5</p>
            </div>
            
            <!-- API URL Config (Hidden/ReadOnly) -->
            <div class="w-full sm:w-auto flex flex-col gap-2">
                <label class="text-xs font-semibold uppercase text-gray-500">API Endpoint</label>
                <div class="flex gap-2">
                    <input type="text" id="apiUrlInput" readonly
                           class="border rounded px-3 py-1 text-sm w-full sm:w-64 bg-gray-100 text-gray-500 cursor-not-allowed">
                </div>
            </div>
        </div>

        <!-- LOGIN BAR -->
        <div class="glass p-4 rounded-xl border border-emerald-100 flex flex-col sm:flex-row items-center gap-4 shadow-sm">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label class="text-xs font-bold text-gray-500 uppercase">Role:</label>
                <select id="userRoleSelect" class="border rounded px-2 py-1 text-sm bg-white focus:outline-emerald-500">
                    <option value="nanny">Nanny / Educator</option>
                    <option value="parent">Parent / Guardian</option>
                </select>
            </div>
            <div class="flex items-center gap-2 w-full">
                <label class="text-xs font-bold text-gray-500 uppercase whitespace-nowrap">User ID:</label>
                <input type="text" id="userIdInput" placeholder="Paste UUID (e.g. 2acf41...)" 
                       class="border rounded px-3 py-1 text-sm w-full focus:outline-emerald-500 font-mono text-gray-600">
            </div>
            <button onclick="handleLogin()" class="bg-emerald-600 text-white px-6 py-1 rounded text-sm hover:bg-emerald-700 font-bold shadow-sm transition w-full sm:w-auto">
                LOGIN
            </button>
        </div>
        <div id="statusMsg" class="text-xs text-right h-4 text-emerald-600 font-bold"></div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="app" class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- LEFT COL: CHILD LIST -->
        <div class="md:col-span-1 space-y-6">
            <div class="glass p-4 rounded-xl shadow-sm border border-emerald-100 min-h-[200px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Assigned Children</h3>
                    <button onclick="fetchChildren()" class="text-xs text-emerald-600 hover:underline"><i class="fa-solid fa-sync"></i></button>
                </div>
                
                <div id="childList" class="space-y-2">
                    <div class="text-center py-8 text-gray-400 text-sm italic">
                        Login to view children.
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COL: ACTIVE CHILD WORKSPACE -->
        <div class="md:col-span-2">
            
            <!-- Welcome Placeholder -->
            <div id="emptyState" class="glass h-96 rounded-xl shadow-sm border border-emerald-100 flex flex-col items-center justify-center text-gray-400 p-8 text-center">
                <i class="fa-solid fa-child-reaching text-6xl mb-4 text-emerald-200"></i>
                <p>Select a child from the list to view their Learning Journey.</p>
            </div>

            <!-- Active Child View -->
            <div id="childView" class="hidden space-y-6">
                
                <!-- Child Header -->
                <div class="glass p-6 rounded-xl shadow-sm border border-emerald-100 flex justify-between items-start bg-gradient-to-r from-white to-emerald-50">
                    <div>
                        <h2 id="activeChildName" class="text-2xl font-bold text-gray-800">Child Name</h2>
                        <p id="activeChildDob" class="text-sm text-gray-500">DOB: --</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 bg-emerald-100 text-emerald-800 text-xs rounded-full font-bold">Active Profile</span>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200 gap-6">
                    <button onclick="switchTab('assess')" id="tab-assess" class="pb-2 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 transition-colors">Assess & Review</button>
                    <button onclick="switchTab('plan')" id="tab-plan" class="pb-2 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors">Plan & Do</button>
                </div>

                <!-- TAB 1: ASSESS (Progress Matrix) -->
                <div id="view-assess" class="glass p-6 rounded-xl shadow-sm border border-emerald-100 animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">Current Mastery</h3>
                        <button onclick="fetchProfile()" class="text-xs text-emerald-600 hover:underline"><i class="fa-solid fa-rotate-right mr-1"></i>Refresh</button>
                    </div>
                    
                    <div id="masteryList" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Mastery Items -->
                    </div>

                    <!-- Add Manual Log Section -->
                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <h4 class="text-sm font-bold mb-3 text-gray-600">Log New Observation</h4>
                        <div class="flex gap-2">
                            <input type="text" id="manualMilestoneId" placeholder="ID (e.g. CL-03-A)" class="border rounded px-3 py-2 text-sm w-full focus:outline-emerald-500">
                            <select id="manualScore" class="border rounded px-3 py-2 text-sm focus:outline-emerald-500 bg-white">
                                <option value="0">0 - Unattempted</option>
                                <option value="1">1 - Introduced</option>
                                <option value="2">2 - Guided</option>
                                <option value="3">3 - Assisted</option>
                                <option value="4">4 - Independent</option>
                            </select>
                            <button onclick="submitLog()" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm hover:bg-emerald-700 transition">Log</button>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: PLAN (Activity Generator) -->
                <div id="view-plan" class="hidden glass p-6 rounded-xl shadow-sm border border-emerald-100 animate-fade-in">
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-700 mb-2">Select Objectives</h3>
                        <p class="text-xs text-gray-500 mb-4">Choose up to 3 milestones to focus on.</p>
                        
                        <div id="objectiveSelector" class="flex flex-wrap gap-2 mb-4">
                            <input type="text" id="objInput" placeholder="Add ID (e.g. PD-03-B)" class="border rounded px-3 py-1 text-sm focus:outline-emerald-500 w-48">
                            <button onclick="addObjective()" class="text-emerald-600 text-sm hover:text-emerald-800 font-bold"><i class="fa-solid fa-plus-circle"></i> Add</button>
                        </div>
                        
                        <!-- Selected Objectives -->
                        <div id="selectedObjectives" class="flex flex-wrap gap-2 min-h-[44px] p-2 bg-gray-50 rounded border border-gray-200 mb-4 items-center">
                            <span class="text-gray-400 text-xs italic px-1">No objectives selected...</span>
                        </div>

                        <button onclick="generateActivity()" id="genBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 transition transform hover:scale-[1.01]">
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate Activity
                        </button>
                    </div>

                    <!-- Result Area -->
                    <div id="activityResult" class="hidden border-t pt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-indigo-900">AI Generated Plan</h4>
                            <span id="activityStatusBadge" class="text-xs font-mono bg-yellow-100 text-yellow-800 px-2 py-1 rounded">PENDING</span>
                        </div>
                        <div id="activityContent" class="bg-indigo-50 p-4 rounded-lg text-sm font-mono text-indigo-900 whitespace-pre-wrap max-h-96 overflow-y-auto shadow-inner border border-indigo-100">
                            Waiting for AI...
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIG ---
        // UPDATED URL
        const API_URL = "https://script.google.com/macros/s/AKfycbyalx3VXoHDaOsXHyYSluBxR34xJTUnhO_B66pgYJafxS1v09qTgLzeR4kEHU4kszba/exec";
        
        let CURRENT_USER_ID = localStorage.getItem('bloom_user_id') || "";
        let CURRENT_ROLE = localStorage.getItem('bloom_user_role') || "nanny";
        
        let ACTIVE_CHILD_ID = null;
        let SELECTED_OBJECTIVES = [];
        let POLLING_INTERVAL = null;

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('apiUrlInput').value = API_URL; // Display only
            document.getElementById('userIdInput').value = CURRENT_USER_ID;
            document.getElementById('userRoleSelect').value = CURRENT_ROLE;

            if (CURRENT_USER_ID) {
                fetchChildren();
            }
        });

        function handleLogin() {
            const id = document.getElementById('userIdInput').value.trim();
            const role = document.getElementById('userRoleSelect').value;

            if(!id) return alert("Please enter a User ID");
            
            localStorage.setItem('bloom_user_id', id);
            localStorage.setItem('bloom_user_role', role);
            
            CURRENT_USER_ID = id;
            CURRENT_ROLE = role;

            fetchChildren();
        }

        // --- API HELPERS (CORS BYPASS) ---
        async function callApi(payload) {
            try {
                // To bypass CORS in GAS, we use 'text/plain' and 'follow'
                const response = await fetch(API_URL, {
                    redirect: "follow", 
                    method: 'POST',
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8", 
                    },
                    body: JSON.stringify(payload)
                });
                
                const text = await response.text();
                
                if (text.includes("<!DOCTYPE html>") || text.includes("accounts.google.com")) {
                     throw new Error("Authentication Error: The script returned a Login Page instead of JSON. Please ensure the Deployment is set to 'Anyone' (Anonymous) access.");
                }

                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error("Invalid JSON received: " + text.substring(0, 50) + "...");
                }

            } catch (e) {
                console.error("API Fetch Error:", e);
                alert("API Error: " + e.message);
                return null;
            }
        }

        // --- CORE FUNCTIONS ---

        async function fetchChildren() {
            const listEl = document.getElementById('childList');
            listEl.innerHTML = '<div class="text-center py-4"><div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-emerald-200 h-6 w-6 mx-auto"></div></div>';
            
            const actionType = (CURRENT_ROLE === 'parent') ? "getParentChildren" : "getEducatorChildren";
            const payload = { action: actionType };
            if (CURRENT_ROLE === 'parent') {
                payload.parentId = CURRENT_USER_ID;
            } else {
                payload.nannyId = CURRENT_USER_ID;
            }

            const res = await callApi(payload);

            listEl.innerHTML = "";

            if (res && res.status === "success" && res.data.length > 0) {
                res.data.forEach(child => {
                    const div = document.createElement('div');
                    div.className = "p-3 bg-white border border-gray-200 rounded-lg hover:shadow-md cursor-pointer transition flex justify-between items-center group";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold text-xs">
                                ${child.firstName.charAt(0)}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 group-hover:text-emerald-700">${child.firstName}</p>
                                <p class="text-[10px] text-gray-500">DOB: ${child.dob.split(' ')[0]}</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-emerald-500"></i>
                    `;
                    div.onclick = () => loadChild(child);
                    listEl.appendChild(div);
                });
            } else {
                const errMsg = res ? res.message : "Connection failed";
                listEl.innerHTML = `<p class="text-sm text-red-500 text-center py-2 bg-red-50 rounded border border-red-100">${errMsg}</p>`;
            }
        }

        async function loadChild(child) {
            ACTIVE_CHILD_ID = child.childId;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('childView').classList.remove('hidden');
            document.getElementById('activeChildName').innerText = child.firstName;
            document.getElementById('activeChildDob').innerText = "DOB: " + child.dob.split(' ')[0];

            fetchProfile();
        }

        async function fetchProfile() {
            const masteryList = document.getElementById('masteryList');
            masteryList.innerHTML = '<p class="text-xs text-gray-400 p-2">Loading progress matrix...</p>';

            const res = await callApi({
                action: "getEduProfile",
                childId: ACTIVE_CHILD_ID
            });

            if (res && res.status === "success") {
                renderMastery(res.data.mastery);
            }
        }

        function renderMastery(masteryObj) {
            const container = document.getElementById('masteryList');
            container.innerHTML = "";

            if (Object.keys(masteryObj).length === 0) {
                container.innerHTML = "<p class='text-sm text-gray-500 italic p-2'>No milestones recorded yet. Log one below.</p>";
                return;
            }

            Object.keys(masteryObj).forEach(key => {
                const score = masteryObj[key];
                const row = document.createElement('div');
                row.className = "flex justify-between items-center p-2 hover:bg-gray-50 rounded border-b border-gray-100 transition";
                
                let scoreColor = "bg-gray-200 text-gray-600";
                if(score === 4) scoreColor = "bg-green-100 text-green-700 border border-green-200";
                if(score === 0) scoreColor = "bg-red-50 text-red-400 border border-red-100";

                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200">${key}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold px-2 py-1 rounded-full ${scoreColor}">Level ${score}</span>
                        <button onclick="populateLogInput('${key}', ${score})" class="text-gray-300 hover:text-emerald-600 px-2 transition">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function populateLogInput(id, score) {
            document.getElementById('manualMilestoneId').value = id;
            document.getElementById('manualScore').value = score;
        }

        async function submitLog() {
            const id = document.getElementById('manualMilestoneId').value;
            const score = document.getElementById('manualScore').value;

            if(!id) return alert("Enter a Milestone ID");

            const btn = document.querySelector('button[onclick="submitLog()"]');
            const originalText = btn.innerText;
            btn.innerText = "...";
            
            const res = await callApi({
                action: "logObservation",
                childId: ACTIVE_CHILD_ID,
                milestoneId: id,
                score: parseInt(score)
            });

            btn.innerText = originalText;

            if(res && res.status === "success") {
                fetchProfile();
                document.getElementById('manualMilestoneId').value = "";
            } else {
                alert("Update failed");
            }
        }

        function addObjective() {
            const input = document.getElementById('objInput');
            const val = input.value.trim();
            if(!val) return;
            
            if(SELECTED_OBJECTIVES.includes(val)) return;
            if(SELECTED_OBJECTIVES.length >= 3) {
                alert("Max 3 objectives");
                return;
            }

            SELECTED_OBJECTIVES.push(val);
            input.value = "";
            renderObjectives();
        }

        function renderObjectives() {
            const container = document.getElementById('selectedObjectives');
            if(SELECTED_OBJECTIVES.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-xs italic px-1">No objectives selected...</span>';
                return;
            }
            container.innerHTML = "";
            SELECTED_OBJECTIVES.forEach(obj => {
                const tag = document.createElement('span');
                tag.className = "bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded border border-indigo-200 flex items-center gap-2 shadow-sm";
                tag.innerHTML = `${obj} <i class="fa-solid fa-times cursor-pointer hover:text-red-500 transition" onclick="removeObjective('${obj}')"></i>`;
                container.appendChild(tag);
            });
        }

        function removeObjective(id) {
            SELECTED_OBJECTIVES = SELECTED_OBJECTIVES.filter(x => x !== id);
            renderObjectives();
        }

        async function generateActivity() {
            if(SELECTED_OBJECTIVES.length === 0) return alert("Add at least 1 objective");

            const btn = document.getElementById('genBtn');
            const resArea = document.getElementById('activityResult');
            const statusBadge = document.getElementById('activityStatusBadge');
            const contentArea = document.getElementById('activityContent');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Queueing...';
            
            const res = await callApi({
                action: "generateActivity",
                childId: ACTIVE_CHILD_ID,
                objectives: SELECTED_OBJECTIVES
            });

            if(res && res.status === "success") {
                const activityId = res.data.activityId;
                
                resArea.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-hourglass-start mr-2"></i> Generating...';
                statusBadge.className = "text-xs font-mono bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200";
                statusBadge.innerText = "PROCESSING";
                contentArea.innerText = "Request queued. AI is thinking...";

                if(POLLING_INTERVAL) clearInterval(POLLING_INTERVAL);
                let attempts = 0;
                
                POLLING_INTERVAL = setInterval(async () => {
                    attempts++;
                    if(attempts > 30) {
                        clearInterval(POLLING_INTERVAL);
                        btn.disabled = false;
                        btn.innerHTML = "Generate Activity";
                        statusBadge.innerText = "TIMEOUT";
                        statusBadge.className = "text-xs font-mono bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200";
                        return;
                    }

                    const pollRes = await callApi({
                        action: "checkActivityStatus",
                        activityId: activityId
                    });

                    if(pollRes && pollRes.data && pollRes.data.status === "complete") {
                        clearInterval(POLLING_INTERVAL);
                        btn.disabled = false;
                        btn.innerHTML = "Generate New Activity";
                        
                        statusBadge.innerText = "READY";
                        statusBadge.className = "text-xs font-mono bg-green-100 text-green-800 px-2 py-1 rounded border border-green-200";
                        
                        const resultData = pollRes.data.activity;
                        contentArea.innerText = typeof resultData === 'object' ? JSON.stringify(resultData, null, 2) : resultData;
                    }
                }, 3000); 

            } else {
                btn.disabled = false;
                btn.innerText = "Generate Activity";
                alert("Failed to queue activity");
            }
        }

        // --- UI HELPERS ---
        function switchTab(tab) {
            if(tab === 'assess') {
                document.getElementById('view-assess').classList.remove('hidden');
                document.getElementById('view-plan').classList.add('hidden');
                document.getElementById('tab-assess').className = "pb-2 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 transition-colors";
                document.getElementById('tab-plan').className = "pb-2 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors";
            } else {
                document.getElementById('view-assess').classList.add('hidden');
                document.getElementById('view-plan').classList.remove('hidden');
                document.getElementById('tab-plan').className = "pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-colors";
                document.getElementById('tab-assess').className = "pb-2 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors";
            }
        }
    </script>
</body>
</html>
