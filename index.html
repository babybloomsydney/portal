<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Bloom | Social MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js -->
    
    <style>
        body { background-color: #f8fafc; padding-bottom: 80px; } /* Space for FAB */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); }
        .tab-active { border-bottom: 3px solid #10b981; color: #065f46; font-weight: bold; }
        .tab-inactive { color: #64748b; }
        .fab-menu { transition: transform 0.2s; }
        .fab-open { transform: rotate(45deg); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Accordion Styles */
        .accordion-content { transition: max-height 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .accordion-open { max-height: 1000px; }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen">

    <!-- 1. TOP NAV: Context & Tabs -->
    <div class="fixed top-0 w-full z-50 bg-white/95 border-b border-gray-200 shadow-sm">
        <!-- Top Bar: Child Selector -->
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="childAvatar" class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold text-lg">
                    ?
                </div>
                <div>
                    <h1 id="childNameTitle" class="text-lg font-bold leading-tight">Loading...</h1>
                    <p class="text-xs text-gray-400 cursor-pointer hover:text-emerald-600" onclick="logout()">Switch Child</p>
                </div>
            </div>
            <!-- Settings / Login (Hidden if logged in) -->
            <button id="loginBtn" onclick="showLoginModal()" class="hidden text-sm bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full font-bold">Login</button>
        </div>

        <!-- Segmented Control (Tabs) -->
        <div class="max-w-md mx-auto grid grid-cols-2 text-center text-sm font-medium border-t border-gray-100">
            <button onclick="switchView('feed')" id="nav-feed" class="py-3 tab-active">
                FEED
            </button>
            <button onclick="switchView('progress')" id="nav-progress" class="py-3 tab-inactive">
                PROGRESS
            </button>
        </div>
    </div>

    <!-- 2. MAIN CONTENT AREA -->
    <div class="max-w-md mx-auto mt-28 px-4">

        <!-- VIEW: FEED -->
        <div id="view-feed" class="space-y-4">
            <!-- Feed Loader -->
            <div id="feedLoader" class="text-center py-10 text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                <p class="text-xs mt-2">Updating timeline...</p>
            </div>
            <!-- Feed Container -->
            <div id="feedContainer" class="space-y-4 pb-20"></div>
        </div>

        <!-- VIEW: PROGRESS -->
        <div id="view-progress" class="hidden space-y-6">
             <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-gray-700 mb-4">Domain Balance</h3>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-gray-700 mb-2">Recent Observations</h3>
                <div id="progressStats" class="text-sm text-gray-500">
                    Loading stats...
                </div>
            </div>
        </div>

    </div>

    <!-- 3. FLOATING ACTION BUTTON (FAB) -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-3">
        <!-- FAB Menu Items (Hidden by default) -->
        <div id="fabMenu" class="hidden flex flex-col items-end gap-3 mb-2">
            <button onclick="openPlanModal()" class="flex items-center gap-3 bg-white text-slate-700 py-2 px-4 rounded-full shadow-lg border border-slate-100 animate-slide-up">
                <span class="font-bold text-sm">Plan Activity</span>
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            </button>
            <button onclick="openLogModal()" class="flex items-center gap-3 bg-white text-slate-700 py-2 px-4 rounded-full shadow-lg border border-slate-100 animate-slide-up">
                <span class="font-bold text-sm">Log Observation</span>
                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fa-solid fa-eye"></i></div>
            </button>
        </div>
        <!-- Main FAB -->
        <button onclick="toggleFab()" id="fabBtn" class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center text-2xl fab-menu">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- 4. MODALS -->
    
    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[60] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Welcome Back</h2>
            <div class="space-y-3">
                <select id="loginRole" class="w-full border p-2 rounded-lg"><option value="nanny">Nanny</option><option value="parent">Parent</option></select>
                <input id="loginId" type="text" placeholder="Enter ID..." class="w-full border p-2 rounded-lg font-mono text-sm">
                <button onclick="doLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold">Login</button>
            </div>
        </div>
    </div>

    <!-- PLAN ACTIVITY MODAL (Accordion) -->
    <div id="planModal" class="fixed inset-0 z-[60] bg-white hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-white">
            <h2 class="font-bold text-lg">New Activity Plan</h2>
            <button onclick="closeModals()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <p class="text-xs text-gray-500 mb-4">Select up to 3 milestones to target.</p>
            <div id="milestoneAccordion" class="space-y-2"></div>
        </div>
        <div class="p-4 border-t bg-white">
            <div id="selectedCount" class="text-xs text-gray-400 mb-2">0 selected</div>
            <button onclick="submitPlan()" id="submitPlanBtn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Generate Plan</button>
        </div>
    </div>

    <!-- LOG OBSERVATION MODAL -->
    <div id="logModal" class="fixed inset-0 z-[60] bg-black/50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Log Observation</h2>
                <button onclick="closeModals()"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <!-- Domain Select -->
                <div>
                    <label class="text-xs font-bold text-gray-500">DOMAIN</label>
                    <select id="logDomain" onchange="filterLogOptions()" class="w-full border p-2 rounded-lg text-sm mt-1">
                        <option value="">Select Domain...</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <!-- Milestone Select -->
                <div>
                    <label class="text-xs font-bold text-gray-500">MILESTONE</label>
                    <select id="logMilestone" class="w-full border p-2 rounded-lg text-sm mt-1 truncate">
                        <option value="">Select Domain First...</option>
                    </select>
                </div>
                <!-- Rating -->
                <div>
                    <label class="text-xs font-bold text-gray-500">MASTERY LEVEL</label>
                    <div class="grid grid-cols-5 gap-1 mt-1 text-center">
                        <button onclick="setRating(0)" class="rate-btn p-2 rounded border text-xs" data-val="0">0</button>
                        <button onclick="setRating(1)" class="rate-btn p-2 rounded border text-xs" data-val="1">1</button>
                        <button onclick="setRating(2)" class="rate-btn p-2 rounded border text-xs" data-val="2">2</button>
                        <button onclick="setRating(3)" class="rate-btn p-2 rounded border text-xs" data-val="3">3</button>
                        <button onclick="setRating(4)" class="rate-btn p-2 rounded border text-xs" data-val="4">4</button>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1 px-1">
                        <span>Unattempted</span><span>Independent</span>
                    </div>
                </div>

                <button onclick="submitObservation()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold mt-2">Save Record</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONSTANTS & STATE ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzoiDfHl_HU-YY-ZEeYjU038y09lB0k2lg_NLxBpvmT8m93ZpyCU_kTeVuqsSIN7qGr/exec";
        
        let STATE = {
            user: { id: localStorage.getItem('bb_uid'), role: localStorage.getItem('bb_role') },
            child: null, // {id, name}
            library: [], // All Milestones
            feed: [],
            selectedObjectives: [],
            logRating: null
        };

        const DOMAINS = {
            "CL": "Communication", "PSE": "Social/Emotional", "PD": "Physical",
            "LIT": "Literacy", "NUM": "Numeracy", "UW": "World", "EAD": "Art & Design"
        };

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            if(STATE.user.id) {
                initApp();
            } else {
                showLoginModal();
            }
        });

        function initApp() {
            closeModals();
            document.getElementById('loginBtn').classList.add('hidden');
            
            // 1. Fetch Child
            fetchChildren(); // Selects first child automatically for MVP
            
            // 2. Fetch Library (Async, caching)
            callApi({ action: "getMilestoneLibrary" }).then(res => {
                if(res.status === "success") {
                    STATE.library = res.data;
                    buildAccordion();
                    buildLogDropdowns();
                }
            });
        }

        // --- API & DATA ---
        async function callApi(payload) {
            try {
                const res = await fetch(API_URL, {
                    redirect: "follow",
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return await res.json();
            } catch (e) {
                console.error(e);
                return { status: "error", message: e.message };
            }
        }

        async function fetchChildren() {
            const action = STATE.user.role === 'parent' ? "getParentChildren" : "getEducatorChildren";
            const payload = { action: action, [STATE.user.role === 'parent' ? 'parentId' : 'nannyId']: STATE.user.id };
            
            const res = await callApi(payload);
            if(res.status === "success" && res.data.length > 0) {
                const child = res.data[0]; // MVP: Auto-select first
                STATE.child = child;
                document.getElementById('childNameTitle').innerText = child.firstName;
                document.getElementById('childAvatar').innerText = child.firstName.charAt(0);
                
                loadFeed();
                loadCharts();
            } else {
                alert("No children found. Check ID.");
                logout();
            }
        }

        async function loadFeed() {
            const container = document.getElementById('feedContainer');
            const res = await callApi({ action: "getChildFeed", childId: STATE.child.childId });
            document.getElementById('feedLoader').classList.add('hidden');
            
            if(res.status === "success") {
                STATE.feed = res.data;
                renderFeed();
            }
        }

        async function loadCharts() {
            const res = await callApi({ action: "getDashboardData", childId: STATE.child.childId });
            if(res.status === "success") {
                renderRadar(res.data.scores);
            }
        }

        // --- RENDERERS ---

        function renderFeed() {
            const container = document.getElementById('feedContainer');
            container.innerHTML = "";
            
            if(STATE.feed.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10">No history yet. Start by planning an activity!</div>`;
                return;
            }

            STATE.feed.forEach(item => {
                let card = "";
                
                // TYPE 1: OBSERVATION
                if(item.type === "OBSERVATION") {
                    const objData = JSON.parse(item.objectives || '{"list":[]}');
                    const firstObj = objData.list[0] || {};
                    card = `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-bold mb-1">OBSERVATION</p>
                                <p class="text-sm text-gray-800 font-medium line-clamp-2">${getMilestoneDesc(firstObj.id)}</p>
                                <div class="mt-2 inline-block px-2 py-1 bg-emerald-100 text-emerald-800 text-xs font-bold rounded">
                                    Marked as Level ${firstObj.score}
                                </div>
                            </div>
                        </div>
                    `;
                }
                // TYPE 2: ACTIVITY (PENDING OR COMPLETED)
                else {
                    const isCompleted = item.type === "COMPLETED";
                    const statusColor = isCompleted ? "bg-slate-100 text-slate-500" : "bg-indigo-100 text-indigo-600";
                    const icon = isCompleted ? "fa-check-circle" : "fa-clock";
                    const title = item.data?.["Creative Name"] || "Generating Activity...";
                    const desc = item.data?.["Activity"] || "Waiting for AI...";

                    card = `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 rounded text-[10px] font-bold ${statusColor}">
                                    <i class="fa-solid ${icon} mr-1"></i> ${isCompleted ? "COMPLETED" : "READY"}
                                </span>
                                <span class="text-[10px] text-gray-400">${item.timestamp.split(' ')[0]}</span>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg mb-1">${title}</h3>
                            <p class="text-sm text-gray-500 line-clamp-3 mb-3">${desc}</p>
                            ${!isCompleted ? 
                                `<button onclick="completeActivity('${item.activityId}')" class="w-full py-2 border border-indigo-200 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-50">View & Complete</button>` : 
                                `<button class="text-xs text-gray-400 font-bold">View History</button>`
                            }
                        </div>
                    `;
                }
                container.innerHTML += card;
            });
        }

        function renderRadar(scores) {
            const ctx = document.getElementById('radarChart');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(DOMAINS).map(k => DOMAINS[k]),
                    datasets: [{
                        label: 'Mastery Score',
                        data: Object.keys(DOMAINS).map(k => scores[k] || 0),
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        pointBackgroundColor: '#fff',
                    }]
                },
                options: {
                    scales: { r: { beginAtZero: true, ticks: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- ACCORDION LOGIC ---
        function buildAccordion() {
            const container = document.getElementById('milestoneAccordion');
            container.innerHTML = "";
            
            // Group by Domain -> Age
            const grouped = {};
            STATE.library.forEach(m => {
                if(!grouped[m.domain]) grouped[m.domain] = {};
                if(!grouped[m.domain][m.age]) grouped[m.domain][m.age] = [];
                grouped[m.domain][m.age].push(m);
            });

            Object.keys(grouped).forEach((domain, dIdx) => {
                const domainId = `d-${dIdx}`;
                let ageHtml = "";
                
                Object.keys(grouped[domain]).forEach((age, aIdx) => {
                    let itemsHtml = grouped[domain][age].map(m => `
                        <label class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer">
                            <input type="checkbox" value="${m.id}" onchange="toggleObjective(this)" class="mt-1">
                            <span class="text-xs text-slate-600">${m.desc}</span>
                        </label>
                    `).join("");

                    ageHtml += `
                        <div class="border-l-2 border-slate-200 ml-2 pl-2 mt-2">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">${age}</p>
                            <div class="space-y-1">${itemsHtml}</div>
                        </div>
                    `;
                });

                const html = `
                    <div class="border rounded-xl mb-2 overflow-hidden">
                        <button onclick="toggleAccordion('${domainId}')" class="w-full flex justify-between items-center p-3 bg-white font-bold text-sm text-slate-700">
                            ${domain}
                            <i id="icon-${domainId}" class="fa-solid fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="${domainId}" class="accordion-content bg-white px-3 pb-3">
                            ${ageHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function toggleAccordion(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if(el.classList.contains('accordion-open')) {
                el.classList.remove('accordion-open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                el.classList.add('accordion-open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // --- ACTIONS ---

        function toggleObjective(chk) {
            if(chk.checked) {
                if(STATE.selectedObjectives.length >= 3) {
                    alert("Max 3 objectives.");
                    chk.checked = false;
                    return;
                }
                STATE.selectedObjectives.push(chk.value);
            } else {
                STATE.selectedObjectives = STATE.selectedObjectives.filter(id => id !== chk.value);
            }
            document.getElementById('selectedCount').innerText = `${STATE.selectedObjectives.length} selected`;
        }

        async function submitPlan() {
            if(STATE.selectedObjectives.length === 0) return alert("Select at least 1 milestone.");
            
            const btn = document.getElementById('submitPlanBtn');
            btn.innerText = "Generating...";
            btn.disabled = true;

            const res = await callApi({
                action: "generateActivity",
                childId: STATE.child.childId,
                objectives: STATE.selectedObjectives
            });

            if(res.status === "success") {
                closeModals();
                switchView('feed');
                loadFeed(); // Refresh
                STATE.selectedObjectives = []; // Reset
            } else {
                alert("Failed: " + res.message);
            }
            btn.innerText = "Generate Plan";
            btn.disabled = false;
        }

        function buildLogDropdowns() {
            const dSelect = document.getElementById('logDomain');
            dSelect.innerHTML = '<option value="">Select Domain...</option>';
            Object.keys(DOMAINS).forEach(k => {
                // Find full name from library to match CSV
                const example = STATE.library.find(m => m.id.startsWith(k));
                if(example) dSelect.innerHTML += `<option value="${example.domain}">${example.domain}</option>`;
            });
        }

        function filterLogOptions() {
            const dVal = document.getElementById('logDomain').value;
            const mSelect = document.getElementById('logMilestone');
            mSelect.innerHTML = '<option value="">Select Milestone...</option>';
            
            const filtered = STATE.library.filter(m => m.domain === dVal);
            filtered.forEach(m => {
                mSelect.innerHTML += `<option value="${m.id}">${m.desc.substring(0, 50)}...</option>`;
            });
        }

        function setRating(val) {
            STATE.logRating = val;
            document.querySelectorAll('.rate-btn').forEach(b => {
                b.classList.remove('bg-emerald-600', 'text-white');
                if(parseInt(b.dataset.val) === val) b.classList.add('bg-emerald-600', 'text-white');
            });
        }

        async function submitObservation() {
            const mId = document.getElementById('logMilestone').value;
            if(!mId || STATE.logRating === null) return alert("Complete all fields");

            const res = await callApi({
                action: "logObservation",
                childId: STATE.child.childId,
                milestoneId: mId,
                score: STATE.logRating,
                isAdHoc: true
            });

            if(res.status === "success") {
                closeModals();
                loadFeed();
                loadCharts();
            }
        }

        // --- UTILS ---
        function switchView(view) {
            document.getElementById('view-feed').classList.add('hidden');
            document.getElementById('view-progress').classList.add('hidden');
            document.getElementById('nav-feed').className = "py-3 tab-inactive";
            document.getElementById('nav-progress').className = "py-3 tab-inactive";
            
            document.getElementById('view-' + view).classList.remove('hidden');
            document.getElementById('nav-' + view).className = "py-3 tab-active";
        }

        function toggleFab() {
            const menu = document.getElementById('fabMenu');
            const btn = document.getElementById('fabBtn');
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                btn.classList.add('fab-open', 'bg-red-500');
                btn.innerHTML = '<i class="fa-solid fa-times"></i>';
            } else {
                menu.classList.add('hidden');
                btn.classList.remove('fab-open', 'bg-red-500');
                btn.innerHTML = '<i class="fa-solid fa-plus"></i>';
            }
        }

        function openPlanModal() { toggleFab(); document.getElementById('planModal').classList.remove('hidden'); }
        function openLogModal() { toggleFab(); document.getElementById('logModal').classList.remove('hidden'); }
        function closeModals() { 
            document.getElementById('planModal').classList.add('hidden'); 
            document.getElementById('logModal').classList.add('hidden'); 
            document.getElementById('loginModal').classList.add('hidden');
        }

        function getMilestoneDesc(id) {
            const m = STATE.library.find(x => x.id === id);
            return m ? m.desc : id;
        }

        function showLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
        function doLogin() {
            const id = document.getElementById('loginId').value.trim();
            const role = document.getElementById('loginRole').value;
            if(id) {
                localStorage.setItem('bb_uid', id);
                localStorage.setItem('bb_role', role);
                location.reload();
            }
        }
        function logout() { localStorage.clear(); location.reload(); }

    </script>
</body>
</html>
